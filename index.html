<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>شاخص آلودگی هوای ایران</title>

<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.min.css" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Vazirmatn,Tahoma;}
body{background:linear-gradient(135deg,#e3f2fd,#ede7f6);color:#222;}
header{text-align:center;padding:16px;font-size:26px;font-weight:900;color:#1e88e5;}
main{max-width:1000px;margin:auto;padding:12px;display:none;}
footer{text-align:center;padding:14px;color:#555;font-size:14px}

/* Loader */
#loader{position:fixed;inset:0;background:#f5f9ff;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999}
.spinner{width:60px;height:60px;border:6px solid #bbdefb;border-top-color:#1e88e5;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Search */
.search-box{display:flex;justify-content:center;margin-bottom:20px}
.search-box input{width:100%;max-width:360px;padding:12px;border-radius:16px;border:none;font-size:15px}

/* Cards */
.list{display:grid;gap:14px}
.card{display:flex;justify-content:space-between;align-items:center;padding:16px;border-radius:22px;background:rgba(255,255,255,0.6)}
.city{font-size:18px;font-weight:900}
.sub{font-size:13px;color:#555}
.aqi-box{min-width:90px;text-align:center;padding:10px;border-radius:16px;color:#fff;font-weight:900}

.good{background:#4caf50}
.mid{background:#ffc107}
.bad{background:#ff7043}
.danger{background:#e53935}
</style>
</head>

<body>

<div id="loader">
  <div class="spinner"></div>
</div>

<header>شاخص آلودگی هوای ایران</header>

<main>
  <div class="search-box">
    <input id="search" placeholder="جستجوی استان...">
  </div>

  <div id="meanAQI">میانگین آلودگی کل ایران: --</div>
  <div class="list" id="list"></div>
</main>

<footer>ساخته شده با عشق ❤️</footer>

<script>
const STATE_API = "https://iran-locations-api.ir/api/v1/fa/states";
const AQI_API = "https://air-quality-api.open-meteo.com/v1/air-quality";

const list = document.getElementById("list");
const meanDiv = document.getElementById("meanAQI");

function cls(v){
  if(v <= 50) return "aqi-box good";
  if(v <= 100) return "aqi-box mid";
  if(v <= 150) return "aqi-box bad";
  return "aqi-box danger";
}

async function load(){
  const res = await fetch(STATE_API);
  const states = await res.json();

  let aqiList = [];
  list.innerHTML = "";

  for(const s of states){
    const lat = s.latitude;
    const lon = s.longitude;

    const r = await fetch(`${AQI_API}?latitude=${lat}&longitude=${lon}&hourly=us_aqi`);
    const j = await r.json();
    const aqi = j?.hourly?.us_aqi?.[0] ?? "--";

    if(aqi !== "--") aqiList.push(aqi);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div>
        <div class="city">${s.name}</div>
        <div class="sub">مرکز: ${s.center}</div>
      </div>
      <div class="${cls(aqi)}">${aqi}</div>
    `;
    list.appendChild(card);
  }

  if(aqiList.length){
    const avg = (aqiList.reduce((a,b)=>a+b,0)/aqiList.length).toFixed(1);
    meanDiv.innerText = `میانگین آلودگی کل ایران: ${avg}`;
  }
}

document.getElementById("search").addEventListener("input",e=>{
  const q = e.target.value.trim();
  document.querySelectorAll(".card").forEach(c=>{
    c.style.display = c.innerText.includes(q) ? "flex" : "none";
  });
});

window.onload = ()=>{
  setTimeout(()=>{
    loader.style.display="none";
    document.querySelector("main").style.display="block";
    load();
  },1500);
};
</script>

</body>
</html>
