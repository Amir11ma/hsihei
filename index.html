<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø´Ø§Ø®Øµ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ù‡ÙˆØ§ÛŒ Ø§ÛŒØ±Ø§Ù†</title>

<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.min.css" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Vazirmatn,Tahoma;}
body{background:linear-gradient(135deg,#e3f2fd,#ede7f6);color:#222;overflow-x:hidden;}
header{text-align:center;padding:16px;font-size:26px;font-weight:900;color:#1e88e5;}
main{max-width:1000px;margin:auto;padding:12px;display:none;}
footer{text-align:center;padding:14px;color:#555;font-size:14px;}

/* ===== Loader ===== */
#loader{position:fixed;inset:0;background:#f5f9ff;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;}
.loader-title{font-size:28px;font-weight:900;color:#1e88e5;margin-bottom:20px;}
.spinner{width:60px;height:60px;border:6px solid #bbdefb;border-top-color:#1e88e5;border-radius:50%;animation:spin 1s linear infinite;}
.loader-footer{margin-top:20px;color:#555;font-size:14px;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== Search ===== */
.search-box{display:flex;justify-content:center;position:relative;margin-bottom:20px;}
.search-box input{width:100%;max-width:360px;padding:12px 42px 12px 16px;border-radius:16px;border:none;outline:none;background:rgba(255,255,255,0.7);backdrop-filter:blur(10px);font-size:15px;box-shadow:0 8px 24px rgba(0,0,0,0.12);transition:0.3s;}
.search-box input:focus{transform:scale(1.03);box-shadow:0 12px 30px rgba(30,136,229,0.35);}
.search-box::after{content:"ğŸ”";position:absolute;margin-top:12px;margin-left:-40px;pointer-events:none;}

/* ===== Mean AQI ===== */
#meanAQI{text-align:center;font-size:20px;font-weight:700;margin-bottom:14px;color:#1e88e5;}

/* ===== Cards ===== */
.list{display:grid;gap:14px;}
.card{display:flex;justify-content:space-between;align-items:center;padding:16px;border-radius:22px;background:rgba(255,255,255,0.55);backdrop-filter:blur(16px);box-shadow:0 15px 35px rgba(0,0,0,0.15);transition:0.3s;}
.card:hover{transform:scale(1.02);box-shadow:0 18px 40px rgba(0,0,0,0.2);}
.city{font-size:18px;font-weight:900;}
.sub{font-size:13px;color:#555;margin-top:4px;}
.aqi-box{min-width:90px;text-align:center;padding:10px;border-radius:16px;color:#fff;font-weight:900;font-size:18px;}
.change-box{font-size:13px;margin-top:4px;font-weight:700;}

/* Colors */
.good{background:#4caf50;}
.mid{background:#ffc107;}
.bad{background:#ff7043;}
.danger{background:#e53935;}
.change-up{color:#e53935;}
.change-down{color:#4caf50;}
</style>
</head>
<body>

<!-- Loader -->
<div id="loader">
  <div class="loader-title">Ø´Ø§Ø®Øµ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ù‡ÙˆØ§ÛŒ Ø§ÛŒØ±Ø§Ù†</div>
  <div class="spinner"></div>
  <div class="loader-footer">Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ Ø¹Ø´Ù‚ ØªÙˆØ³Ø· BGM STUDIO</div>
</div>

<header>Ø´Ø§Ø®Øµ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ù‡ÙˆØ§ÛŒ Ø§ÛŒØ±Ø§Ù†</header>

<main>
  <div class="search-box">
    <input id="search" placeholder="Ù†Ø§Ù… Ø´Ù‡Ø± Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯...">
  </div>

  <div id="meanAQI">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ú©Ù„ Ø§ÛŒØ±Ø§Ù†: --</div>

  <div class="list" id="list"></div>
</main>

<footer>Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ Ø¹Ø´Ù‚ ØªÙˆØ³Ø· BGM STUDIO</footer>

<script>
const API="https://air-quality-api.open-meteo.com/v1/air-quality";
const list=document.getElementById("list");
const meanDiv=document.getElementById("meanAQI");
let previousData=JSON.parse(localStorage.getItem("aqiData")||"{}");

// ØªØ§Ø¨Ø¹ Ú©Ù„Ø§Ø³ Ø¨Ù†Ø¯ÛŒ AQI
function cls(v){
  if(v<=50)return"aqi-box good";
  if(v<=100)return"aqi-box mid";
  if(v<=150)return"aqi-box bad";
  return"aqi-box danger";
}

// Ù„ÙˆØ¯ Ù‡Ù…Ù‡ Ø´Ù‡Ø±Ù‡Ø§ Ø§Ø² JSON
async function loadCities(){
  const res = await fetch("cities.json");
  const json = await res.json();
  const citiesArray = json.cities.data; // Ù…Ø³ÛŒØ± Ø¯Ø±Ø³Øª Ø¯Ø§Ø®Ù„ JSON
  return citiesArray.map(c=>({
    name: c.city,
    lat: parseFloat(c.latitude),
    lon: parseFloat(c.longitude)
  }));
}

// Ù„ÙˆØ¯ AQI Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø´Ù‡Ø±Ù‡Ø§
async function load(){
  list.innerHTML="";
  const cities = await loadCities();

  const promises = cities.map(async ({name,lat,lon})=>{
    try{
      const r = await fetch(`${API}?latitude=${lat}&longitude=${lon}&hourly=us_aqi`);
      const j = await r.json();
      const aqi = j?.hourly?.us_aqi?.[0] ?? "--";
      return {c: name, aqi};
    }catch(e){
      return {c: name, aqi: "--"};
    }
  });

  const results = await Promise.all(promises);

  // Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† AQI
  const validAQI = results.filter(r=>r.aqi!=="--").map(r=>r.aqi);
  const meanAQI = validAQI.length ? (validAQI.reduce((a,b)=>a+b,0)/validAQI.length).toFixed(1) : "--";
  meanDiv.innerText=`Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ú©Ù„ Ø§ÛŒØ±Ø§Ù†: ${meanAQI}`;

  results.forEach(({c,aqi})=>{
    const prev = previousData[c];
    let changeText="ØªØºÛŒÛŒØ±: 0";
    let changeClass="";
    if(prev!==undefined && prev!=="--" && aqi!=="--"){
      const diff = aqi-prev;
      if(diff>0){changeText=`ØªØºÛŒÛŒØ±: +${diff}`; changeClass="change-up";}
      else if(diff<0){changeText=`ØªØºÛŒÛŒØ±: ${diff}`; changeClass="change-down";}
    }
    previousData[c]=aqi;

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div>
        <div class="city">${c}</div>
        <div class="sub">${aqi<=50?"Ø®ÙˆØ¨":aqi<=100?"Ù…ØªÙˆØ³Ø·":aqi<=150?"Ù†Ø§Ù…Ù†Ø§Ø³Ø¨":"Ø¨Ø¯"}</div>
        <div class="change-box ${changeClass}">${changeText}</div>
      </div>
      <div class="${cls(aqi)}"><span>${aqi}</span></div>
    `;
    list.appendChild(card);
  });

  localStorage.setItem("aqiData",JSON.stringify(previousData));
}

// Ø¬Ø³ØªØ¬Ùˆ
document.getElementById("search").addEventListener("input",e=>{
  const q=e.target.value.trim().toLowerCase();
  document.querySelectorAll(".card").forEach(card=>{
    card.style.display = card.querySelector(".city").innerText.toLowerCase().includes(q)?"flex":"none";
  });
});

window.onload=()=>{
  setTimeout(()=>{
    loader.style.display="none";
    document.querySelector("main").style.display="block";
    load();
  },2500);
};
</script>
</body>
</html>
